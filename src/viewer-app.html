<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/color.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/typography.html">
<link rel="import" href="../bower_components/vaadin-item/vaadin-item.html">
<link rel="import" href="../bower_components/vaadin-list-box/vaadin-list-box.html">
<link rel="import" href="../bower_components/vaadin-ordered-layout/vaadin-horizontal-layout.html">
<link rel="import" href="../bower_components/vaadin-progress-bar/vaadin-progress-bar.html">
<link rel="import" href="../bower_components/vaadin-tabs/vaadin-tabs.html">

<link rel="import" href="viewer-link.html">
<link rel="import" href="viewer-demo-nav.html">

<dom-module id="viewer-app">
  <template>
    <style include="lumo-typography lumo-color">
      :host {
        display: block;
      }

      .wrapper {
        height: 100vh;
        background: var(--lumo-shade-5pct);
      }

      .left {
        min-width: 256px;
        overflow: auto;
      }

      .right {
        position: relative;
        height: 100%;
        width: 100%;
      }

      iframe {
        position: absolute;
        top: 65px;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: calc(100% - 65px);
        background: #fafafa;
      }

      vaadin-tabs {
        margin-top: var(--lumo-space-s);
      }

      vaadin-tab {
        min-width: 100px;
      }
    </style>

    <iron-location id="url" path="null" hash="{{hash}}"></iron-location>

    <iron-ajax id="ajax" auto handle-as="json"></iron-ajax>

    <vaadin-horizontal-layout class="wrapper">

      <div class="left">
        <vaadin-list-box selected="{{selected}}">
          <dom-repeat items="[[items]]">
            <template>
              <vaadin-item>[[item.name]]</vaadin-item>
            </template>
          </dom-repeat>
        </vaadin-list-box>
      </div>

      <div class="right" hidden$="[[!selectedItem]]">
        <vaadin-tabs selected="{{selectedTab}}" theme="minimal">
          <dom-repeat items="[[tabs]]">
            <template>
              <vaadin-tab>
                <viewer-link text="[[item.text]]" name="[[item.name]]" link="[[_computeLink(selectedItem, item.name)]]"></viewer-link>
              </vaadin-tab>
            </template>
          </dom-repeat>
          <viewer-demo-nav element="[[selectedItem.name]]" hidden$="[[_computeNavHidden(hash, loaded)]]"></viewer-demo-nav>
        </vaadin-tabs>
        <vaadin-progress-bar hidden$="[[!loading]]" indeterminate></vaadin-progress-bar>
        <iframe id="frame" frameborder="0" height="100%" width="100%"></iframe>
      </div>

    </vaadin-horizontal-layout>

  </template>
  <script>
    class ViewerApp extends Polymer.Element {

      static get is() {
        return 'viewer-app';
      }

      static get properties() {
        return {
          hash: {
            type: String
          },
          items: {
            type: Array
          },
          selected: {
            type: Number,
            observer: '_selectedChanged'
          },
          loaded: {
            type: Boolean
          },
          loading: {
            type: Boolean
          },
          selectedItem: {
            type: Object
          },
          selectedTab: {
            type: Number
          },
          tabs: {
            type: Array,
            value: function() {
              return [
                {
                  name: 'docs',
                  text: 'API docs'
                },
                {
                  name: 'demo',
                  text: 'Demo'
                }
              ];
            }
          }
        };
      }

      ready() {
        super.ready();

        Polymer.RenderStatus.afterNextRender(this, () => {
          this.$.ajax.addEventListener('response', this._onResponse.bind(this));
          this.$.frame.addEventListener('load', this._onFrameLoad.bind(this));
          this.$.ajax.url = 'catalog.json';
          this.addEventListener('link-clicked', this._onLinkClicked.bind(this));
          this.addEventListener('demo-selected', this._onDemoSelected.bind(this));
        });
      }

      _computeLink(item, name) {
        return item ? item[name] : null;
      }

      _computeNavHidden(hash, loaded) {
        return !loaded || hash !== 'demo';
      }

      _onResponse(e) {
        const elements = Object.keys(e.detail.response.packages);

        this.items = elements.map(el => ({
          name: el,
          demo: `./dist/${el}/bower_components/${el}/demo/`,
          docs: `./dist/${el}/#/namespaces/Vaadin/`
        }));

        const query = this.$.url.query;
        const hash = this.$.url.hash;
        if (query && hash) {
          this._updateSelectedTab(hash);
          setTimeout(() => {
            const index = elements.indexOf(query);
            if (index > -1) {
              this.selected = index;
            }
          }, 1);
        } else {
          this.selected = 0;
          this._updateSelectedTab('docs');
        }
      }

      _onDemoSelected(e) {
        // async to prevent freeze on dropdown close
        setTimeout(() => {
          const doc = this.$.frame.contentDocument || this.$.frame.contentWindow.document;
          const demo = doc.querySelector('vaadin-component-demo');
          if (demo) {
            demo.selectedPage = e.detail.demo;
          }
        });
      }

      _onLinkClicked(e) {
        const name = e.detail.name;
        this.loaded = false;
        this.loading = true;
        this._updateSelectedTab(name);
        this.selectedTab = this.tabs.map(tab => tab.name).indexOf(name);
        this.$.frame.src = e.detail.url;
        this.$.url.query = this.selectedItem.name;
        this.$.url.hash = name;
      }

      _onFrameLoad() {
        this.loading = false;
        this.loaded = true;
      }

      _selectedChanged(selected) {
        if (selected === 'undefined' || selected === -1) {
          return;
        }

        this.set('selectedItem', this.items[selected]);

        this.shadowRoot.querySelector('vaadin-tab[selected] > viewer-link').click();
      }

      _updateSelectedTab(name) {
        this.selectedTab = this.tabs.map(tab => tab.name).indexOf(name);
      }
    }

    customElements.define(ViewerApp.is, ViewerApp);
  </script>
</dom-module>
